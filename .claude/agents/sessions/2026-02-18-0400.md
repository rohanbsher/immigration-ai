# Session: 2026-02-18 04:00

## What I Did

Set up the complete production infrastructure for the Immigration AI application.

### Services Configured
1. **Supabase Production** — Created new instance (project ref: sforzkbeahfkeilynbwk), pushed all 46 SQL migrations, verified all applied
2. **Upstash Redis** — Provisioned sharing-buffalo-59262.upstash.io for production rate limiting (chose Upstash over Railway Redis for serverless compatibility with Vercel)
3. **Resend** — Configured for transactional email (DNS verification pending custom domain purchase)
4. **Sentry** — Set up error tracking (org: immigration-ai-ni, project: javascript-nextjs)
5. **Stripe** — Configured in test mode with 4 price IDs (Pro Monthly/Yearly, Enterprise Monthly/Yearly) and webhook endpoint
6. **OpenAI + Anthropic** — Reused dev API keys with billing enabled
7. **VirusTotal** — Reused dev API key for file scanning
8. **Vercel** — Updated all 29 production environment variables via REST API

### Build Issues Fixed
- Removed `ALLOW_IN_MEMORY_RATE_LIMIT` from Vercel (no longer needed with real Redis)
- Removed empty `PDF_SERVICE_URL` from Vercel (empty string `""` caused Zod `.url().optional()` validation failure — needs `undefined` not `""`)

### Smoke Tests Passed
- Homepage: 200
- Health endpoint: healthy
- Login page: 200
- API auth guards: working (401 on unauthenticated requests)
- Supabase REST: 200

## Files Changed
- `.env.production` — Created with all production values (gitignored)
- `supabase/config.toml` — Removed deprecated `[project]` section, updated `major_version` to 17

## Decisions Made
- **Upstash over Railway Redis:** Upstash is purpose-built for serverless (Vercel). Railway Redis would require persistent connections that don't fit Vercel's serverless model.
- **Supabase Free plan:** Sufficient for launch. Can upgrade to Pro ($25/mo) when usage grows.
- **Stripe test keys:** Using test mode until ready for real payments. Will switch to live keys when custom domain is set.
- **PDF_SERVICE_URL left unset:** The app falls back to summary PDFs when the URL is not configured. The Railway PDF microservice can be deployed later.

## For Next Agent
- **Continue with:** Custom domain purchase and configuration (update `NEXT_PUBLIC_APP_URL`, `NEXT_PUBLIC_SITE_URL`, Supabase `SITE_URL`)
- **After domain:** Complete Resend DNS verification for email delivery
- **Optional:** Deploy Railway PDF service for USCIS-format PDF generation
- **Optional:** Switch Stripe from test to live mode when ready for billing
- **Watch out for:** `PDF_SERVICE_URL` must be completely absent (not empty string) or Zod validation will fail the build

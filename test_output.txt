
> immigration-ai@0.1.0 test:run
> vitest run


[1m[46m RUN [49m[22m [36mv4.0.18 [39m[90m/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai[39m

[90mstderr[2m | src/lib/email/index.test.ts[2m > [22m[2mEmail Module[2m > [22m[2msendEmail[2m > [22m[2mshould handle Resend API error
[22m[39mResend error: { message: [32m'Rate limit exceeded'[39m }

[90mstderr[2m | src/lib/email/index.test.ts[2m > [22m[2mEmail Module[2m > [22m[2msendEmail[2m > [22m[2mshould handle network/exception errors
[22m[39mEmail send error: Error: Network error
    at [90m/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/lib/email/index.test.ts:205:44
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:145:11
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:26
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1209:10[90m)[39m
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1653:37
    at Traces.$ [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.CCmnQaNT.js:142:27[90m)[39m
    at trace [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1653:12[90m)[39m

[90mstderr[2m | src/lib/email/index.test.ts[2m > [22m[2mEmail Module[2m > [22m[2msendEmail[2m > [22m[2mshould handle non-Error exceptions
[22m[39mEmail send error: String error

[90mstderr[2m | src/lib/email/index.test.ts[2m > [22m[2mEmail Module - Resend Not Configured[2m > [22m[2mshould handle missing Resend configuration
[22m[39mEmail not sent: Resend is not configured

 [32mâœ“[39m src/lib/email/index.test.ts [2m([22m[2m18 tests[22m[2m)[22m[32m 272[2mms[22m[39m
[90mstderr[2m | src/lib/config/env.test.ts[2m > [22m[2mConfig/Env Module[2m > [22m[2mpublic environment variables (env)[2m > [22m[2mshould throw error for missing required Supabase URL
[22m[39m[Config] Invalid public environment variables:
  - NEXT_PUBLIC_SUPABASE_URL: Invalid input: expected string, received undefined

[90mstderr[2m | src/lib/config/env.test.ts[2m > [22m[2mConfig/Env Module[2m > [22m[2mpublic environment variables (env)[2m > [22m[2mshould throw error for missing required Supabase anon key
[22m[39m[Config] Invalid public environment variables:
  - NEXT_PUBLIC_SUPABASE_ANON_KEY: Invalid input: expected string, received undefined

[90mstderr[2m | src/lib/config/env.test.ts[2m > [22m[2mConfig/Env Module[2m > [22m[2mpublic environment variables (env)[2m > [22m[2mshould throw error for invalid Supabase URL format
[22m[39m[Config] Invalid public environment variables:
  - NEXT_PUBLIC_SUPABASE_URL: Invalid Supabase URL

[90mstderr[2m | src/lib/config/env.test.ts[2m > [22m[2mConfig/Env Module[2m > [22m[2mpublic environment variables (env)[2m > [22m[2mshould validate NEXT_PUBLIC_POSTHOG_HOST as URL
[22m[39m[Config] Invalid public environment variables:
  - NEXT_PUBLIC_POSTHOG_HOST: Invalid URL

 [32mâœ“[39m src/lib/config/env.test.ts [2m([22m[2m37 tests[22m[2m | [22m[33m3 skipped[39m[2m)[22m[32m 155[2mms[22m[39m
 [31mâ¯[39m src/lib/ai/index.test.ts [2m([22m[2m111 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[32m 33[2mms[22m[39m
         [32mâœ“[39m should return passport prompt for passport document type[32m 1[2mms[22m[39m
         [32mâœ“[39m should return birth certificate prompt for birth_certificate type[32m 0[2mms[22m[39m
         [32mâœ“[39m should return marriage certificate prompt for marriage_certificate type[32m 0[2mms[22m[39m
         [32mâœ“[39m should return employment letter prompt for employment_letter type[32m 0[2mms[22m[39m
         [32mâœ“[39m should return bank statement prompt for bank_statement type[32m 0[2mms[22m[39m
         [32mâœ“[39m should return generic prompt for unknown document type[32m 0[2mms[22m[39m
         [32mâœ“[39m should return generic prompt for empty string[32m 0[2mms[22m[39m
         [32mâœ“[39m should return I-130 prompt for I-130 form type[32m 0[2mms[22m[39m
         [32mâœ“[39m should return I-485 prompt for I-485 form type[32m 0[2mms[22m[39m
         [32mâœ“[39m should return I-765 prompt for I-765 form type[32m 0[2mms[22m[39m
         [32mâœ“[39m should return N-400 prompt for N-400 form type[32m 0[2mms[22m[39m
         [32mâœ“[39m should return I-130 prompt as default for unknown form type[32m 0[2mms[22m[39m
         [32mâœ“[39m should have DOCUMENT_ANALYSIS_SYSTEM_PROMPT defined[32m 1[2mms[22m[39m
         [32mâœ“[39m should have FORM_AUTOFILL_SYSTEM_PROMPT defined[32m 0[2mms[22m[39m
         [32mâœ“[39m DOCUMENT_ANALYSIS_SYSTEM_PROMPT should include key instructions[32m 0[2mms[22m[39m
         [32mâœ“[39m FORM_AUTOFILL_SYSTEM_PROMPT should include key instructions[32m 0[2mms[22m[39m
         [32mâœ“[39m should map full_name to I-130 form field[32m 0[2mms[22m[39m
         [32mâœ“[39m should map full_name to I-485 form field[32m 0[2mms[22m[39m
         [32mâœ“[39m should map full_name to I-765 form field[32m 0[2mms[22m[39m
         [32mâœ“[39m should map full_name to N-400 form field[32m 0[2mms[22m[39m
         [32mâœ“[39m should return null for unknown form type[32m 0[2mms[22m[39m
         [32mâœ“[39m should return null for unmapped field name[32m 0[2mms[22m[39m
         [32mâœ“[39m should handle date_of_birth mapping for I-130[32m 0[2mms[22m[39m
         [32mâœ“[39m should handle null value in extracted field[32m 0[2mms[22m[39m
         [32mâœ“[39m should preserve requires_review flag from requires_verification[32m 0[2mms[22m[39m
         [32mâœ“[39m should return required documents for I-130[32m 1[2mms[22m[39m
         [32mâœ“[39m should return required documents for I-485[32m 0[2mms[22m[39m
         [32mâœ“[39m should return required documents for I-765[32m 0[2mms[22m[39m
         [32mâœ“[39m should return required documents for N-400[32m 0[2mms[22m[39m
         [32mâœ“[39m should return empty array for unknown form type[32m 0[2mms[22m[39m
         [32mâœ“[39m should ignore visaType parameter (currently unused)[32m 0[2mms[22m[39m
         [32mâœ“[39m should return unfilled fields for I-130[32m 0[2mms[22m[39m
         [32mâœ“[39m should return all required fields when no fields are filled[32m 0[2mms[22m[39m
         [32mâœ“[39m should return empty array when all required fields are filled[32m 0[2mms[22m[39m
         [32mâœ“[39m should handle I-485 form type[32m 0[2mms[22m[39m
         [32mâœ“[39m should handle I-765 form type[32m 0[2mms[22m[39m
         [32mâœ“[39m should handle N-400 form type[32m 0[2mms[22m[39m
         [32mâœ“[39m should return empty array for unknown form type[32m 0[2mms[22m[39m
         [32mâœ“[39m should consider both suggested_value and current_value as filled[32m 0[2mms[22m[39m
         [32mâœ“[39m should calculate completion percentage correctly[32m 0[2mms[22m[39m
         [32mâœ“[39m should cap percentage at 100[32m 0[2mms[22m[39m
         [32mâœ“[39m should count high confidence fields correctly[32m 0[2mms[22m[39m
         [32mâœ“[39m should handle fields with current_value[32m 0[2mms[22m[39m
         [32mâœ“[39m should return correct total for each form type[32m 0[2mms[22m[39m
         [32mâœ“[39m should default to 20 for unknown form type[32m 0[2mms[22m[39m
         [32mâœ“[39m should handle empty fields array[32m 0[2mms[22m[39m
         [32mâœ“[39m should handle fields without confidence[32m 0[2mms[22m[39m
         [32mâœ“[39m should accept valid passport with all required fields[32m 0[2mms[22m[39m
         [32mâœ“[39m should flag low overall confidence[32m 0[2mms[22m[39m
         [32mâœ“[39m should flag missing required fields for passport[32m 0[2mms[22m[39m
         [32mâœ“[39m should suggest review for low confidence fields[32m 0[2mms[22m[39m
         [32mâœ“[39m should flag expiring passport (less than 6 months validity)[32m 0[2mms[22m[39m
         [32mâœ“[39m should handle birth certificate validation[32m 0[2mms[22m[39m
         [32mâœ“[39m should handle marriage certificate validation[32m 0[2mms[22m[39m
         [32mâœ“[39m should handle employment letter validation[32m 0[2mms[22m[39m
         [32mâœ“[39m should include warnings from analysis result in suggestions[32m 0[2mms[22m[39m
         [32mâœ“[39m should handle unknown document type gracefully[32m 0[2mms[22m[39m
         [32mâœ“[39m should handle null field values[32m 0[2mms[22m[39m
         [32mâœ“[39m should successfully analyze document with imageUrl[32m 0[2mms[22m[39m
         [32mâœ“[39m should successfully analyze document with imageBase64[32m 0[2mms[22m[39m
         [32mâœ“[39m should throw error when neither imageUrl nor imageBase64 provided[32m 2[2mms[22m[39m
         [32mâœ“[39m should throw error when no response content[32m 0[2mms[22m[39m
         [32mâœ“[39m should throw error for invalid JSON response[32m 0[2mms[22m[39m
         [32mâœ“[39m should handle 401 unauthorized error[32m 1[2mms[22m[39m
         [32mâœ“[39m should handle 429 rate limit error[32m 0[2mms[22m[39m
         [32mâœ“[39m should handle 400 bad request error[32m 0[2mms[22m[39m
         [32mâœ“[39m should use high detail when high_accuracy_mode is enabled[32m 1[2mms[22m[39m
         [32mâœ“[39m should extract text from image[32m 0[2mms[22m[39m
         [32mâœ“[39m should return 0 confidence for empty text[32m 0[2mms[22m[39m
         [32mâœ“[39m should detect passport type[32m 0[2mms[22m[39m
         [32mâœ“[39m should return other for unknown documents[32m 0[2mms[22m[39m
         [32mâœ“[39m should handle empty response[32m 0[2mms[22m[39m
         [32mâœ“[39m should handle invalid JSON response[32m 0[2mms[22m[39m
         [32mâœ“[39m should validate a good document image[32m 0[2mms[22m[39m
         [32mâœ“[39m should reject blank images[32m 0[2mms[22m[39m
         [32mâœ“[39m should handle empty response[32m 0[2mms[22m[39m
         [32mâœ“[39m should handle parse errors[32m 1[2mms[22m[39m
         [32mâœ“[39m should generate autofill suggestions from extracted data[32m 1[2mms[22m[39m
         [32mâœ“[39m should handle JSON response wrapped in markdown code blocks[32m 0[2mms[22m[39m
         [32mâœ“[39m should throw error when no text content in response[32m 0[2mms[22m[39m
[31m         [31mÃ—[31m should throw error when JSON cannot be parsed[39m[32m 6[2mms[22m[39m
         [32mâœ“[39m should handle 401 unauthorized error[32m 0[2mms[22m[39m
         [32mâœ“[39m should handle 429 rate limit error[32m 2[2mms[22m[39m
         [32mâœ“[39m should include case context when provided[32m 0[2mms[22m[39m
         [32mâœ“[39m should validate form data and return issues[32m 0[2mms[22m[39m
         [32mâœ“[39m should return default valid response when no content[32m 0[2mms[22m[39m
         [32mâœ“[39m should return default response when JSON parse fails[32m 0[2mms[22m[39m
         [32mâœ“[39m should explain form requirements[32m 0[2mms[22m[39m
         [32mâœ“[39m should return empty string when no content[32m 0[2mms[22m[39m
         [32mâœ“[39m should analyze data consistency across documents[32m 0[2mms[22m[39m
         [32mâœ“[39m should return perfect consistency when no content[32m 0[2mms[22m[39m
         [32mâœ“[39m should return perfect consistency when JSON parse fails[32m 0[2mms[22m[39m
         [32mâœ“[39m should suggest next steps based on case data[32m 0[2mms[22m[39m
         [32mâœ“[39m should return empty steps when no content[32m 0[2mms[22m[39m
         [32mâœ“[39m should return empty steps when JSON parse fails[32m 0[2mms[22m[39m
         [32mâœ“[39m should analyze document with progress callbacks[32m 0[2mms[22m[39m
         [32mâœ“[39m should return invalid result for invalid document image[32m 0[2mms[22m[39m
         [32mâœ“[39m should throw error when no document URL available[32m 0[2mms[22m[39m
         [32mâœ“[39m should use provided document type instead of detecting[32m 0[2mms[22m[39m
         [32mâœ“[39m should extract only requested fields[32m 0[2mms[22m[39m
         [32mâœ“[39m should extract text from document[32m 0[2mms[22m[39m
         [32mâœ“[39m should identify same documents[32m 0[2mms[22m[39m
         [32mâœ“[39m should identify different document types[32m 0[2mms[22m[39m
         [32mâœ“[39m should identify field differences[32m 0[2mms[22m[39m
         [32mâœ“[39m should autofill form with document analyses[32m 0[2mms[22m[39m
         [32mâœ“[39m should return empty result when no document data[32m 0[2mms[22m[39m
         [32mâœ“[39m should add discrepancy warnings[32m 0[2mms[22m[39m
         [32mâœ“[39m should validate autofill data[32m 0[2mms[22m[39m
       [32mâœ“[39m should export ExtractedField type[32m 0[2mms[22m[39m
       [32mâœ“[39m should export FormField type with all field types[32m 0[2mms[22m[39m
       [32mâœ“[39m should export DocumentAnalysisResult type[32m 0[2mms[22m[39m
[90mstderr[2m | src/app/api/auth/auth.test.ts
[22m[39mRESEND_API_KEY is not set. Email functionality will be disabled.

[90mstderr[2m | src/lib/db/index.test.ts[2m > [22m[2mDatabase Services[2m > [22m[2mcasesService[2m > [22m[2mgetCases[2m > [22m[2mshould throw error when query fails
[22m[39m{"level":"error","message":"Error fetching cases","timestamp":"2026-02-01T19:28:02.995Z","environment":"test","context":{"component":"db:cases"},"error":{"name":"UnknownError","message":"[object Object]"}}

[90mstderr[2m | src/lib/db/index.test.ts[2m > [22m[2mDatabase Services[2m > [22m[2mcasesService[2m > [22m[2mgetCase[2m > [22m[2mshould return null when case not found
[22m[39m{"level":"error","message":"Error fetching case","timestamp":"2026-02-01T19:28:03.005Z","environment":"test","context":{"component":"db:cases","caseId":"non-existent"},"error":{"name":"UnknownError","message":"[object Object]"}}

[90mstderr[2m | src/app/api/cases/cases.test.ts[2m > [22m[2mCases API Routes[2m > [22m[2mGET /api/cases/stats[2m > [22m[2mshould return stats for attorney
[22m[39mError fetching case stats: Error: Missing Supabase admin credentials
    at getAdminClient [90m(/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/lib/supabase/admin.ts:24:13[90m)[39m
    at getProfileAsAdmin [90m(/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/lib/supabase/admin.ts:61:17[90m)[39m
    at authenticate [90m(/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/lib/auth/api-helpers.ts:239:50[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at GET [90m(/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/app/api/cases/stats/route.ts:7:18[90m)[39m
    at [90m/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/app/api/cases/cases.test.ts:911:24
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstderr[2m | src/lib/db/index.test.ts[2m > [22m[2mDatabase Services[2m > [22m[2mcasesService[2m > [22m[2mcreateCase[2m > [22m[2mshould throw error when insert fails
[22m[39m{"level":"error","message":"Error creating case","timestamp":"2026-02-01T19:28:03.016Z","environment":"test","context":{"component":"db:cases"},"error":{"name":"UnknownError","message":"[object Object]"}}

[90mstderr[2m | src/app/api/cases/cases.test.ts[2m > [22m[2mCases API Routes[2m > [22m[2mGET /api/cases/stats[2m > [22m[2mshould return stats for admin
[22m[39mError fetching case stats: Error: Missing Supabase admin credentials
    at getAdminClient [90m(/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/lib/supabase/admin.ts:24:13[90m)[39m
    at getProfileAsAdmin [90m(/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/lib/supabase/admin.ts:61:17[90m)[39m
    at authenticate [90m(/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/lib/auth/api-helpers.ts:239:50[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at GET [90m(/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/app/api/cases/stats/route.ts:7:18[90m)[39m
    at [90m/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/app/api/cases/cases.test.ts:926:24
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstderr[2m | src/lib/db/index.test.ts[2m > [22m[2mDatabase Services[2m > [22m[2mcasesService[2m > [22m[2mupdateCase[2m > [22m[2mshould throw error when update fails
[22m[39m{"level":"error","message":"Error updating case","timestamp":"2026-02-01T19:28:03.018Z","environment":"test","context":{"component":"db:cases","caseId":"case-123"},"error":{"name":"UnknownError","message":"[object Object]"}}

[90mstderr[2m | src/app/api/cases/cases.test.ts[2m > [22m[2mCases API Routes[2m > [22m[2mGET /api/cases/stats[2m > [22m[2mshould return 403 for client
[22m[39mError fetching case stats: Error: Missing Supabase admin credentials
    at getAdminClient [90m(/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/lib/supabase/admin.ts:24:13[90m)[39m
    at getProfileAsAdmin [90m(/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/lib/supabase/admin.ts:61:17[90m)[39m
    at authenticate [90m(/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/lib/auth/api-helpers.ts:239:50[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at GET [90m(/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/app/api/cases/stats/route.ts:7:18[90m)[39m
    at [90m/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/app/api/cases/cases.test.ts:948:24
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstderr[2m | src/app/api/cases/cases.test.ts[2m > [22m[2mCases API Routes[2m > [22m[2mError Handling[2m > [22m[2mshould handle service errors gracefully in PATCH /api/cases/[id]
[22m[39mError updating case: Error: Database error
    at [90m/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/app/api/cases/cases.test.ts:985:57
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:145:11
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:26
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1209:10[90m)[39m
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1653:37
    at Traces.$ [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.CCmnQaNT.js:142:27[90m)[39m
    at trace [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1653:12[90m)[39m

[90mstderr[2m | src/app/api/cases/cases.test.ts[2m > [22m[2mCases API Routes[2m > [22m[2mError Handling[2m > [22m[2mshould handle service errors gracefully in DELETE /api/cases/[id]
[22m[39mError deleting case: Error: Database error
    at [90m/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/app/api/cases/cases.test.ts:999:57
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:145:11
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:26
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1209:10[90m)[39m
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1653:37
    at Traces.$ [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.CCmnQaNT.js:142:27[90m)[39m
    at trace [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1653:12[90m)[39m

[90mstderr[2m | src/app/api/cases/cases.test.ts[2m > [22m[2mCases API Routes[2m > [22m[2mError Handling[2m > [22m[2mshould handle service errors gracefully in GET /api/cases/stats
[22m[39mError fetching case stats: Error: Missing Supabase admin credentials
    at getAdminClient [90m(/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/lib/supabase/admin.ts:24:13[90m)[39m
    at getProfileAsAdmin [90m(/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/lib/supabase/admin.ts:61:17[90m)[39m
    at authenticate [90m(/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/lib/auth/api-helpers.ts:239:50[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at GET [90m(/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/app/api/cases/stats/route.ts:7:18[90m)[39m
    at [90m/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/app/api/cases/cases.test.ts:1017:24
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstderr[2m | src/lib/db/index.test.ts[2m > [22m[2mDatabase Services[2m > [22m[2mcasesService[2m > [22m[2mdeleteCase[2m > [22m[2mshould throw error when delete fails
[22m[39m{"level":"error","message":"Error deleting case","timestamp":"2026-02-01T19:28:03.025Z","environment":"test","context":{"component":"db:cases","caseId":"case-123"},"error":{"name":"UnknownError","message":"[object Object]"}}

 [31mâ¯[39m src/app/api/cases/cases.test.ts [2m([22m[2m51 tests[22m[2m | [22m[31m11 failed[39m[2m)[22m[33m 450[2mms[22m[39m
[31m       [31mÃ—[31m should return cases list for authenticated user[39m[32m 198[2mms[22m[39m
       [32mâœ“[39m should return 401 for unauthenticated user[32m 4[2mms[22m[39m
[31m       [31mÃ—[31m should pass filter parameters to service[39m[32m 7[2mms[22m[39m
[31m       [31mÃ—[31m should handle multiple status filters[39m[32m 3[2mms[22m[39m
[31m       [31mÃ—[31m should create a case for attorney[39m[32m 6[2mms[22m[39m
       [32mâœ“[39m should return 401 for unauthenticated user[32m 2[2mms[22m[39m
[31m       [31mÃ—[31m should return 403 for non-attorney user[39m[32m 1[2mms[22m[39m
[31m       [31mÃ—[31m should return 400 for invalid data[39m[32m 1[2mms[22m[39m
[31m       [31mÃ—[31m should validate client_id is a UUID[39m[32m 1[2mms[22m[39m
       [32mâœ“[39m should return case for attorney owner[32m 61[2mms[22m[39m
       [32mâœ“[39m should return case for client on the case[32m 1[2mms[22m[39m
       [32mâœ“[39m should return 401 for unauthenticated user[32m 0[2mms[22m[39m
       [32mâœ“[39m should return 404 for unauthorized user[32m 0[2mms[22m[39m
       [32mâœ“[39m should return 404 for non-existent case[32m 3[2mms[22m[39m
       [32mâœ“[39m should update case for attorney owner[32m 56[2mms[22m[39m
       [32mâœ“[39m should return 403 for client trying to update[32m 3[2mms[22m[39m
       [32mâœ“[39m should return 401 for unauthenticated user[32m 2[2mms[22m[39m
       [32mâœ“[39m should return 400 for invalid update data[32m 1[2mms[22m[39m
       [32mâœ“[39m should delete case for attorney owner[32m 1[2mms[22m[39m
       [32mâœ“[39m should return 403 for client trying to delete[32m 0[2mms[22m[39m
       [32mâœ“[39m should return 401 for unauthenticated user[32m 0[2mms[22m[39m
       [32mâœ“[39m should return 404 for non-existent case[32m 0[2mms[22m[39m
       [32mâœ“[39m should return documents for case attorney[32m 59[2mms[22m[39m
       [32mâœ“[39m should return documents for case client[32m 4[2mms[22m[39m
       [32mâœ“[39m should return 401 for unauthenticated user[32m 0[2mms[22m[39m
       [32mâœ“[39m should return 403 for unauthorized user[32m 0[2mms[22m[39m
       [32mâœ“[39m should return 401 for unauthenticated user[32m 1[2mms[22m[39m
       [32mâœ“[39m should return 403 for unauthorized user[32m 0[2mms[22m[39m
       [32mâœ“[39m should return 400 when file is missing[32m 0[2mms[22m[39m
       [32mâœ“[39m should return 400 when document_type is missing[32m 1[2mms[22m[39m
       [32mâœ“[39m should return forms for case attorney[32m 11[2mms[22m[39m
       [32mâœ“[39m should return forms for case client[32m 1[2mms[22m[39m
       [32mâœ“[39m should return 401 for unauthenticated user[32m 0[2mms[22m[39m
       [32mâœ“[39m should return 403 for unauthorized user[32m 0[2mms[22m[39m
       [32mâœ“[39m should create form for case attorney[32m 1[2mms[22m[39m
       [32mâœ“[39m should create form for case client[32m 0[2mms[22m[39m
       [32mâœ“[39m should return 401 for unauthenticated user[32m 0[2mms[22m[39m
       [32mâœ“[39m should return 403 for unauthorized user[32m 0[2mms[22m[39m
       [32mâœ“[39m should return 400 for invalid form data[32m 4[2mms[22m[39m
[31m       [31mÃ—[31m should return stats for attorney[39m[32m 11[2mms[22m[39m
[31m       [31mÃ—[31m should return stats for admin[39m[32m 1[2mms[22m[39m
       [32mâœ“[39m should return 401 for unauthenticated user[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should return 403 for client[39m[32m 1[2mms[22m[39m
       [32mâœ“[39m should handle service errors gracefully in GET /api/cases[32m 0[2mms[22m[39m
       [32mâœ“[39m should handle service errors gracefully in POST /api/cases[32m 0[2mms[22m[39m
       [32mâœ“[39m should handle service errors gracefully in PATCH /api/cases/[id][32m 1[2mms[22m[39m
       [32mâœ“[39m should handle service errors gracefully in DELETE /api/cases/[id][32m 0[2mms[22m[39m
       [32mâœ“[39m should handle service errors gracefully in GET /api/cases/stats[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should allow attorney to access their own cases even when filtering by client[39m[32m 0[2mms[22m[39m
       [32mâœ“[39m should correctly identify attorney as case owner[32m 0[2mms[22m[39m
       [32mâœ“[39m should correctly identify client as non-owner (read-only)[32m 0[2mms[22m[39m
[90mstderr[2m | src/lib/db/index.test.ts[2m > [22m[2mDatabase Services[2m > [22m[2mcasesService[2m > [22m[2mgetCaseStats[2m > [22m[2mshould throw error when query fails
[22m[39m{"level":"error","message":"Error fetching case stats","timestamp":"2026-02-01T19:28:03.027Z","environment":"test","context":{"component":"db:cases"},"error":{"name":"UnknownError","message":"[object Object]"}}

[90mstderr[2m | src/lib/db/index.test.ts[2m > [22m[2mDatabase Services[2m > [22m[2mclientsService[2m > [22m[2mgetClient[2m > [22m[2mshould return null when client not found
[22m[39m{"level":"error","message":"Error fetching client","timestamp":"2026-02-01T19:28:03.031Z","environment":"test","context":{"component":"db:clients","clientId":"non-existent"},"error":{"name":"UnknownError","message":"[object Object]"}}

[90mstderr[2m | src/lib/db/index.test.ts[2m > [22m[2mDatabase Services[2m > [22m[2mclientsService[2m > [22m[2mgetClientCases[2m > [22m[2mshould throw error when query fails
[22m[39m{"level":"error","message":"Error fetching client cases","timestamp":"2026-02-01T19:28:03.032Z","environment":"test","context":{"component":"db:clients","clientId":"client-123"},"error":{"name":"UnknownError","message":"[object Object]"}}

[90mstderr[2m | src/lib/db/index.test.ts[2m > [22m[2mDatabase Services[2m > [22m[2mdocumentsService[2m > [22m[2mgetDocument[2m > [22m[2mshould return null when document not found
[22m[39m{"level":"error","message":"Error fetching document","timestamp":"2026-02-01T19:28:03.043Z","environment":"test","context":{"component":"db:documents","documentId":"non-existent"},"error":{"name":"UnknownError","message":"[object Object]"}}

[90mstderr[2m | src/lib/db/index.test.ts[2m > [22m[2mDatabase Services[2m > [22m[2mdocumentsService[2m > [22m[2mgetDocumentChecklist[2m > [22m[2mshould return empty array on error
[22m[39m{"level":"error","message":"Error fetching document checklist","timestamp":"2026-02-01T19:28:03.060Z","environment":"test","context":{"component":"db:documents","visaType":"H1B"},"error":{"name":"UnknownError","message":"[object Object]"}}

[90mstderr[2m | src/lib/db/index.test.ts[2m > [22m[2mDatabase Services[2m > [22m[2mformsService[2m > [22m[2mgetForm[2m > [22m[2mshould return null when form not found
[22m[39m{"level":"error","message":"Error fetching form","timestamp":"2026-02-01T19:28:03.071Z","environment":"test","context":{"component":"db:forms","formId":"non-existent"},"error":{"name":"UnknownError","message":"[object Object]"}}

 [31mâ¯[39m src/lib/auth/index.test.ts [2m([22m[2m78 tests[22m[2m | [22m[31m8 failed[39m[2m)[22m[33m 683[2mms[22m[39m
         [32mâœ“[39m should sign up a new user successfully[32m 2[2mms[22m[39m
         [32mâœ“[39m should include bar number and firm name for attorney signup[32m 1[2mms[22m[39m
         [32mâœ“[39m should throw error when signup fails[32m 1[2mms[22m[39m
         [32mâœ“[39m should sign in a user with email and password[32m 1[2mms[22m[39m
         [32mâœ“[39m should throw error when signin fails[32m 1[2mms[22m[39m
         [32mâœ“[39m should initiate Google OAuth flow[32m 1[2mms[22m[39m
         [32mâœ“[39m should initiate Azure OAuth flow[32m 1[2mms[22m[39m
         [32mâœ“[39m should throw error when OAuth fails[32m 1[2mms[22m[39m
         [32mâœ“[39m should sign out the user successfully[32m 6[2mms[22m[39m
         [32mâœ“[39m should throw error when signout fails[32m 1[2mms[22m[39m
         [32mâœ“[39m should return the current user[32m 1[2mms[22m[39m
         [32mâœ“[39m should throw error when getUser fails[32m 0[2mms[22m[39m
         [32mâœ“[39m should return the current session[32m 1[2mms[22m[39m
         [32mâœ“[39m should throw error when getSession fails[32m 1[2mms[22m[39m
         [32mâœ“[39m should send password reset email[32m 1[2mms[22m[39m
         [32mâœ“[39m should throw error when reset fails[32m 1[2mms[22m[39m
         [32mâœ“[39m should update the user password[32m 1[2mms[22m[39m
         [32mâœ“[39m should throw error when password update fails[32m 0[2mms[22m[39m
         [32mâœ“[39m should subscribe to auth state changes[32m 1[2mms[22m[39m
         [32mâœ“[39m should return the current user on server[32m 1[2mms[22m[39m
         [32mâœ“[39m should return null when user not authenticated[32m 1[2mms[22m[39m
         [32mâœ“[39m should return the current session on server[32m 1[2mms[22m[39m
         [32mâœ“[39m should return null when no session[32m 3[2mms[22m[39m
         [32mâœ“[39m should return user profile[32m 1[2mms[22m[39m
         [32mâœ“[39m should return null when user not authenticated[32m 0[2mms[22m[39m
         [32mâœ“[39m should return null when profile not found[32m 0[2mms[22m[39m
         [32mâœ“[39m should return user when authenticated[32m 0[2mms[22m[39m
         [32mâœ“[39m should throw when not authenticated[32m 2[2mms[22m[39m
         [32mâœ“[39m should extract IP from x-forwarded-for header[32m 2[2mms[22m[39m
         [32mâœ“[39m should extract IP from x-real-ip header[32m 1[2mms[22m[39m
         [32mâœ“[39m should return unknown when no IP headers present[32m 1[2mms[22m[39m
         [32mâœ“[39m should prefer x-forwarded-for over x-real-ip[32m 0[2mms[22m[39m
         [32mâœ“[39m should create error response with status[32m 3[2mms[22m[39m
         [32mâœ“[39m should include details when provided[32m 4[2mms[22m[39m
         [32mâœ“[39m should create success response with default status 200[32m 2[2mms[22m[39m
         [32mâœ“[39m should create success response with custom status[32m 1[2mms[22m[39m
         [32mâœ“[39m should return success for authenticated user[32m 5[2mms[22m[39m
         [32mâœ“[39m should return error when user not authenticated[32m 6[2mms[22m[39m
[31m         [31mÃ—[31m should return error when profile not found[39m[32m 14[2mms[22m[39m
[31m         [31mÃ—[31m should check role when roles option provided[39m[32m 10[2mms[22m[39m
         [32mâœ“[39m should pass when user has required role[32m 14[2mms[22m[39m
         [32mâœ“[39m should return rate limit error when rate limited[32m 10[2mms[22m[39m
         [32mâœ“[39m should skip rate limiting when rateLimit is false[32m 3[2mms[22m[39m
         [32mâœ“[39m should authenticate any user[32m 7[2mms[22m[39m
         [32mâœ“[39m should allow attorney role[32m 16[2mms[22m[39m
[31m         [31mÃ—[31m should reject non-attorney role[39m[32m 70[2mms[22m[39m
[31m         [31mÃ—[31m should allow admin role[39m[32m 2[2mms[22m[39m
         [32mâœ“[39m should reject non-admin role[32m 8[2mms[22m[39m
         [32mâœ“[39m should allow attorney role[32m 14[2mms[22m[39m
         [32mâœ“[39m should allow admin role[32m 14[2mms[22m[39m
[31m         [31mÃ—[31m should reject client role[39m[32m 14[2mms[22m[39m
         [32mâœ“[39m should allow attorney access to their case[32m 7[2mms[22m[39m
         [32mâœ“[39m should allow client access to their case with limited permissions[32m 3[2mms[22m[39m
         [32mâœ“[39m should deny access for unrelated user[32m 17[2mms[22m[39m
         [32mâœ“[39m should return not found for missing case[32m 17[2mms[22m[39m
         [32mâœ“[39m should allow attorney access to document[32m 7[2mms[22m[39m
         [32mâœ“[39m should allow client who uploaded to delete their document[32m 6[2mms[22m[39m
         [32mâœ“[39m should deny access for unrelated user[32m 5[2mms[22m[39m
         [32mâœ“[39m should return not found for missing document[32m 37[2mms[22m[39m
         [32mâœ“[39m should allow attorney access to form[32m 8[2mms[22m[39m
         [32mâœ“[39m should allow client view-only access to form[32m 5[2mms[22m[39m
         [32mâœ“[39m should deny access for unrelated user[32m 4[2mms[22m[39m
         [32mâœ“[39m should return not found for missing form[32m 18[2mms[22m[39m
         [32mâœ“[39m should wrap handler and pass auth to it[32m 5[2mms[22m[39m
         [32mâœ“[39m should return error response when authentication fails[32m 3[2mms[22m[39m
         [32mâœ“[39m should handle errors in handler[32m 36[2mms[22m[39m
[31m         [31mÃ—[31m should pass options to authenticate[39m[32m 41[2mms[22m[39m
         [32mâœ“[39m should require attorney role[32m 12[2mms[22m[39m
[31m         [31mÃ—[31m should reject non-attorney[39m[32m 47[2mms[22m[39m
[31m         [31mÃ—[31m should require admin role[39m[32m 6[2mms[22m[39m
         [32mâœ“[39m should reject non-admin[32m 41[2mms[22m[39m
         [32mâœ“[39m should handle empty email in signIn[32m 20[2mms[22m[39m
         [32mâœ“[39m should handle empty password in signIn[32m 15[2mms[22m[39m
         [32mâœ“[39m should use custom rate limit key when provided[32m 9[2mms[22m[39m
         [32mâœ“[39m should use different rate limit configs[32m 13[2mms[22m[39m
         [32mâœ“[39m should extract first IP from comma-separated list[32m 14[2mms[22m[39m
         [32mâœ“[39m should not find deleted cases[32m 10[2mms[22m[39m
         [32mâœ“[39m should return case not found when document exists but case is deleted[32m 18[2mms[22m[39m
[90mstderr[2m | src/lib/db/index.test.ts[2m > [22m[2mDatabase Services[2m > [22m[2mprofilesService[2m > [22m[2mgetProfile[2m > [22m[2mshould return null when profile not found
[22m[39m{"level":"error","message":"Error fetching profile","timestamp":"2026-02-01T19:28:03.116Z","environment":"test","context":{"component":"db:profiles","userId":"non-existent"},"error":{"name":"UnknownError","message":"[object Object]"}}

[90mstderr[2m | src/lib/db/index.test.ts[2m > [22m[2mDatabase Services[2m > [22m[2mprofilesService[2m > [22m[2mupdateProfile[2m > [22m[2mshould throw error when update fails
[22m[39m{"level":"error","message":"Error updating profile","timestamp":"2026-02-01T19:28:03.154Z","environment":"test","context":{"component":"db:profiles","userId":"user-123"},"error":{"name":"UnknownError","message":"[object Object]"}}

[90mstderr[2m | src/lib/db/index.test.ts[2m > [22m[2mDatabase Services[2m > [22m[2mprofilesService[2m > [22m[2msearchProfiles[2m > [22m[2mshould return empty array on error
[22m[39m{"level":"error","message":"Error searching profiles","timestamp":"2026-02-01T19:28:03.164Z","environment":"test","context":{"component":"db:profiles","query":"Test"},"error":{"name":"UnknownError","message":"[object Object]"}}

[90mstderr[2m | src/lib/db/index.test.ts[2m > [22m[2mDatabase Services[2m > [22m[2mnotificationsService[2m > [22m[2mgetUnreadCount[2m > [22m[2mshould return 0 on error
[22m[39m{"level":"error","message":"Error fetching unread count","timestamp":"2026-02-01T19:28:03.179Z","environment":"test","context":{"component":"db:notifications","userId":"user-123"},"error":{"name":"UnknownError","message":"[object Object]"}}

[90mstderr[2m | src/lib/db/index.test.ts[2m > [22m[2mDatabase Services[2m > [22m[2msubscriptionsService[2m > [22m[2mgetCurrentUsage[2m > [22m[2mshould return empty object on error
[22m[39m{"level":"error","message":"Failed to get usage","timestamp":"2026-02-01T19:28:03.602Z","environment":"test","context":{"component":"db:subscriptions","userId":"user-123"},"error":{"name":"UnknownError","message":"[object Object]"}}

[90mstderr[2m | src/lib/db/index.test.ts[2m > [22m[2mDatabase Services[2m > [22m[2msubscriptionsService[2m > [22m[2mcheckQuota[2m > [22m[2mshould return false on error
[22m[39m{"level":"error","message":"Failed to check quota","timestamp":"2026-02-01T19:28:03.628Z","environment":"test","context":{"component":"db:subscriptions","userId":"user-123","metricName":"ai_requests","requiredQuantity":1},"error":{"name":"UnknownError","message":"[object Object]"}}

 [32mâœ“[39m src/lib/db/index.test.ts [2m([22m[2m134 tests[22m[2m)[22m[33m 683[2mms[22m[39m
[90mstderr[2m | src/app/api/auth/auth.test.ts[2m > [22m[2mAuth API Routes[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 500 for unexpected errors
[22m[39mLogin error: Error: Database connection failed
    at [90m/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/app/api/auth/auth.test.ts:269:48
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:145:11
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:26
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1209:10[90m)[39m
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1653:37
    at Traces.$ [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.CCmnQaNT.js:142:27[90m)[39m
    at trace [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1653:12[90m)[39m

[90mstderr[2m | src/app/api/auth/auth.test.ts[2m > [22m[2mAuth API Routes[2m > [22m[2mPOST /api/auth/register[2m > [22m[2mshould successfully register a new attorney
[22m[39mFailed to send welcome email: TypeError: supabase.from(...).insert is not a function
    at sendEmail [90m(/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/lib/email/index.ts:55:6[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at sendWelcomeEmail [90m(/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/lib/email/notifications.ts:45:3[90m)[39m

[90mstderr[2m | src/app/api/auth/auth.test.ts[2m > [22m[2mAuth API Routes[2m > [22m[2mPOST /api/auth/register[2m > [22m[2mshould successfully register a new client
[22m[39mFailed to send welcome email: TypeError: supabase.from(...).insert is not a function
    at sendEmail [90m(/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/lib/email/index.ts:55:6[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at sendWelcomeEmail [90m(/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/lib/email/notifications.ts:45:3[90m)[39m

[90mstderr[2m | src/app/api/auth/auth.test.ts[2m > [22m[2mAuth API Routes[2m > [22m[2mPOST /api/auth/register[2m > [22m[2mshould handle email confirmation required response
[22m[39mFailed to send welcome email: TypeError: supabase.from(...).insert is not a function
    at sendEmail [90m(/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/lib/email/index.ts:55:6[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at sendWelcomeEmail [90m(/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/lib/email/notifications.ts:45:3[90m)[39m

[90mstderr[2m | src/app/api/auth/auth.test.ts[2m > [22m[2mAuth API Routes[2m > [22m[2mPOST /api/auth/register[2m > [22m[2mshould return 500 for unexpected errors
[22m[39mRegistration error: Error: Network error
    at [90m/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/app/api/auth/auth.test.ts:572:36
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:145:11
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:26
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1209:10[90m)[39m
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1653:37
    at Traces.$ [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.CCmnQaNT.js:142:27[90m)[39m
    at trace [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1653:12[90m)[39m

[90mstderr[2m | src/app/api/auth/auth.test.ts[2m > [22m[2mAuth API Routes[2m > [22m[2mPOST /api/auth/logout[2m > [22m[2mshould return 500 for unexpected errors
[22m[39mLogout error: Error: Connection reset
    at [90m/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/app/api/auth/auth.test.ts:618:37
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:145:11
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:26
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1209:10[90m)[39m
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1653:37
    at Traces.$ [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.CCmnQaNT.js:142:27[90m)[39m
    at trace [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1653:12[90m)[39m

 [32mâœ“[39m src/lib/rate-limit/index.test.ts [2m([22m[2m47 tests[22m[2m)[22m[32m 22[2mms[22m[39m
[90mstderr[2m | src/app/api/auth/auth.test.ts[2m > [22m[2mAuth API Validation Edge Cases[2m > [22m[2mLogin validation[2m > [22m[2mshould handle malformed JSON
[22m[39mLogin error: SyntaxError: Unexpected token 'o', "not valid json" is not valid JSON
    at JSON.parse (<anonymous>)
[90m    at parseJSONFromBytes (node:internal/deps/undici/undici:5738:19)[39m
[90m    at successSteps (node:internal/deps/undici/undici:5719:27)[39m
[90m    at fullyReadBody (node:internal/deps/undici/undici:4609:9)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
[90m    at consumeBody (node:internal/deps/undici/undici:5728:7)[39m
    at Module.POST [90m(/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/app/api/auth/login/route.ts:28:18[90m)[39m
    at [90m/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/app/api/auth/auth.test.ts:854:24
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstderr[2m | src/app/api/auth/auth.test.ts[2m > [22m[2mAuth API Validation Edge Cases[2m > [22m[2mRegister validation[2m > [22m[2mshould handle special characters in names
[22m[39mFailed to send welcome email: TypeError: supabase.from(...).insert is not a function
    at sendEmail [90m(/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/lib/email/index.ts:55:6[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at sendWelcomeEmail [90m(/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/lib/email/notifications.ts:45:3[90m)[39m

[90mstderr[2m | src/app/api/auth/auth.test.ts[2m > [22m[2mAuth API Validation Edge Cases[2m > [22m[2mRegister validation[2m > [22m[2mshould accept exactly 8 character password
[22m[39mFailed to send welcome email: TypeError: supabase.from(...).insert is not a function
    at sendEmail [90m(/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/lib/email/index.ts:55:6[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at sendWelcomeEmail [90m(/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/lib/email/notifications.ts:45:3[90m)[39m

 [32mâœ“[39m src/app/api/auth/auth.test.ts [2m([22m[2m39 tests[22m[2m)[22m[32m 49[2mms[22m[39m
[90mstderr[2m | src/lib/csrf/index.test.ts[2m > [22m[2mCSRF Module[2m > [22m[2mcsrfMiddleware[2m > [22m[2mshould return 403 response for invalid requests
[22m[39mCSRF validation failed: Origin https://malicious.com not allowed

[90mstderr[2m | src/lib/csrf/index.test.ts[2m > [22m[2mCSRF Module[2m > [22m[2mcsrfMiddleware[2m > [22m[2mshould return error JSON body
[22m[39mCSRF validation failed: Origin https://malicious.com not allowed

[90mstderr[2m | src/lib/csrf/index.test.ts[2m > [22m[2mCSRF Module[2m > [22m[2mwithCsrfProtection[2m > [22m[2mshould return 403 without calling handler for invalid requests
[22m[39mCSRF validation failed: Origin https://evil.com not allowed

 [32mâœ“[39m src/lib/csrf/index.test.ts [2m([22m[2m33 tests[22m[2m)[22m[32m 22[2mms[22m[39m
[90mstderr[2m | src/app/api/forms/forms.test.ts[2m > [22m[2mForms API Routes[2m > [22m[2mPATCH /api/forms/[id][2m > [22m[2mshould update form_data when attorney modifies
[22m[39mAudit log error: TypeError: Cannot read properties of undefined (reading 'insert')
    at Object.log [90m(/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/lib/audit/index.ts:164:26[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at Module.PATCH [90m(/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/app/api/forms/[id]/route.ts:154:7[90m)[39m
    at [90m/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/app/api/forms/forms.test.ts:397:24
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstderr[2m | src/app/api/forms/forms.test.ts[2m > [22m[2mForms API Routes[2m > [22m[2mDELETE /api/forms/[id][2m > [22m[2mshould delete form when attorney requests
[22m[39mAudit log error: TypeError: Cannot read properties of undefined (reading 'insert')
    at Object.log [90m(/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/lib/audit/index.ts:164:26[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at Module.DELETE [90m(/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/app/api/forms/[id]/route.ts:221:5[90m)[39m
    at [90m/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/app/api/forms/forms.test.ts:457:24
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstderr[2m | src/app/api/forms/forms.test.ts[2m > [22m[2mForms API Routes[2m > [22m[2mPOST /api/forms/[id]/autofill[2m > [22m[2mshould handle AI service errors gracefully
[22m[39mAI autofill error: Error: AI service unavailable
    at [90m/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/app/api/forms/forms.test.ts:570:49
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:145:11
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:26
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1209:10[90m)[39m
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1653:37
    at Traces.$ [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.CCmnQaNT.js:142:27[90m)[39m
    at trace [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1653:12[90m)[39m

[90mstderr[2m | src/app/api/forms/forms.test.ts[2m > [22m[2mForms API Routes[2m > [22m[2mError handling[2m > [22m[2mshould handle database errors gracefully
[22m[39mError fetching form: Error: Database error
    at [90m/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/app/api/forms/forms.test.ts:784:57
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:145:11
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:26
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1209:10[90m)[39m
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1653:37
    at Traces.$ [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.CCmnQaNT.js:142:27[90m)[39m
    at trace [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1653:12[90m)[39m

[90mstderr[2m | src/app/api/forms/forms.test.ts[2m > [22m[2mForms API Routes[2m > [22m[2mError handling[2m > [22m[2mshould handle update database errors gracefully
[22m[39mError updating form: Error: Database error
    at [90m/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/app/api/forms/forms.test.ts:797:60
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:145:11
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:26
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1209:10[90m)[39m
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1653:37
    at Traces.$ [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.CCmnQaNT.js:142:27[90m)[39m
    at trace [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1653:12[90m)[39m

[90mstderr[2m | src/app/api/forms/forms.test.ts[2m > [22m[2mForms API Routes[2m > [22m[2mError handling[2m > [22m[2mshould handle delete database errors gracefully
[22m[39mAudit log error: TypeError: supabase.from(...).insert is not a function
    at Object.log [90m(/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/lib/audit/index.ts:165:10[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at Module.DELETE [90m(/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/app/api/forms/[id]/route.ts:221:5[90m)[39m
    at [90m/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/app/api/forms/forms.test.ts:813:24
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstderr[2m | src/app/api/forms/forms.test.ts[2m > [22m[2mForms API Routes[2m > [22m[2mError handling[2m > [22m[2mshould handle delete database errors gracefully
[22m[39mError deleting form: Error: Database error
    at [90m/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/app/api/forms/forms.test.ts:810:60
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:145:11
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:26
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1209:10[90m)[39m
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1653:37
    at Traces.$ [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.CCmnQaNT.js:142:27[90m)[39m
    at trace [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1653:12[90m)[39m

 [32mâœ“[39m src/app/api/forms/forms.test.ts [2m([22m[2m37 tests[22m[2m)[22m[32m 38[2mms[22m[39m
[90mstderr[2m | src/app/api/clients/clients.test.ts[2m > [22m[2mClients API Routes[2m > [22m[2mGET /api/clients[2m > [22m[2mshould handle database errors gracefully
[22m[39mError fetching clients: Error: Database error
    at [90m/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/app/api/clients/clients.test.ts:324:62
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:145:11
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:26
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1209:10[90m)[39m
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1653:37
    at Traces.$ [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.CCmnQaNT.js:142:27[90m)[39m
    at trace [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1653:12[90m)[39m

[90mstderr[2m | src/app/api/clients/clients.test.ts[2m > [22m[2mClients API Routes[2m > [22m[2mGET /api/clients/search[2m > [22m[2mshould handle search errors gracefully
[22m[39mError searching clients: Error: Search error
    at [90m/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/app/api/clients/clients.test.ts:437:65
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:145:11
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:26
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1209:10[90m)[39m
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1653:37
    at Traces.$ [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.CCmnQaNT.js:142:27[90m)[39m
    at trace [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1653:12[90m)[39m

[90mstderr[2m | src/app/api/clients/clients.test.ts[2m > [22m[2mClients API Routes[2m > [22m[2mPATCH /api/clients/[id][2m > [22m[2mshould handle update errors gracefully
[22m[39mError updating client: Error: Update error
    at [90m/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/app/api/clients/clients.test.ts:670:64
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:145:11
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:26
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1209:10[90m)[39m
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1653:37
    at Traces.$ [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.CCmnQaNT.js:142:27[90m)[39m
    at trace [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1653:12[90m)[39m

[90mstderr[2m | src/app/api/clients/clients.test.ts[2m > [22m[2mClients API Routes[2m > [22m[2mGET /api/clients/[id]/cases[2m > [22m[2mshould handle database errors gracefully
[22m[39mError fetching client cases: Error: Database error
    at [90m/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/app/api/clients/clients.test.ts:876:66
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:145:11
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:26
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1209:10[90m)[39m
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1653:37
    at Traces.$ [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.CCmnQaNT.js:142:27[90m)[39m
    at trace [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1653:12[90m)[39m

 [32mâœ“[39m src/app/api/clients/clients.test.ts [2m([22m[2m34 tests[22m[2m)[22m[32m 51[2mms[22m[39m
[90mstderr[2m | src/middleware.test.ts[2m > [22m[2mupdateSession (Supabase Middleware)[2m > [22m[2mCSRF Protection[2m > [22m[2mshould return 403 when CSRF validation fails
[22m[39m[6cf23dc1-3a5a-4296-9926-afea5985fbd7] CSRF validation failed: Missing Origin/Referer header

[90mstderr[2m | src/middleware.test.ts[2m > [22m[2mupdateSession (Supabase Middleware)[2m > [22m[2mCSRF Protection[2m > [22m[2mshould include request ID in CSRF error response
[22m[39m[5a61be72-8e7c-43e0-a5a8-b012bb844c11] CSRF validation failed: Invalid origin

 [32mâœ“[39m src/middleware.test.ts [2m([22m[2m43 tests[22m[2m)[22m[32m 25[2mms[22m[39m
[90mstderr[2m | src/lib/audit/index.test.ts[2m > [22m[2mAudit Service[2m > [22m[2mlog[2m > [22m[2mshould return null when no user is authenticated
[22m[39mAudit log: No user found

[90mstderr[2m | src/lib/audit/index.test.ts[2m > [22m[2mAudit Service[2m > [22m[2mlog[2m > [22m[2mshould handle database insert error
[22m[39mFailed to create audit log: { message: [32m'Database error'[39m }

[90mstderr[2m | src/lib/audit/index.test.ts[2m > [22m[2mAudit Service[2m > [22m[2mlog[2m > [22m[2mshould handle exceptions gracefully
[22m[39mAudit log error: Error: Auth service down
    at [90m/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/lib/audit/index.test.ts:224:41
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:145:11
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:26
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1209:10[90m)[39m
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1653:37
    at Traces.$ [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.CCmnQaNT.js:142:27[90m)[39m
    at trace [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1653:12[90m)[39m

[90mstderr[2m | src/lib/audit/index.test.ts[2m > [22m[2mAudit Service[2m > [22m[2mgetLogsForRecord[2m > [22m[2mshould return empty array on error
[22m[39mFailed to fetch audit logs: { message: [32m'Query failed'[39m }

[90mstderr[2m | src/lib/audit/index.test.ts[2m > [22m[2mAudit Service[2m > [22m[2mgetLogsByUser[2m > [22m[2mshould return empty array on error
[22m[39mFailed to fetch audit logs: { message: [32m'Query failed'[39m }

[90mstderr[2m | src/lib/audit/index.test.ts[2m > [22m[2mAudit Service[2m > [22m[2mgetRecentLogs[2m > [22m[2mshould return empty array on error
[22m[39mFailed to fetch audit logs: { message: [32m'Query failed'[39m }

 [32mâœ“[39m src/lib/logger/index.test.ts [2m([22m[2m34 tests[22m[2m)[22m[32m 22[2mms[22m[39m
 [32mâœ“[39m src/lib/audit/index.test.ts [2m([22m[2m25 tests[22m[2m)[22m[32m 30[2mms[22m[39m
 [32mâœ“[39m src/lib/billing/index.test.ts [2m([22m[2m34 tests[22m[2m)[22m[32m 26[2mms[22m[39m
[90mstderr[2m | src/lib/2fa/index.test.ts[2m > [22m[2mQR Code Module[2m > [22m[2mgenerateQRCodeDataURL[2m > [22m[2mshould throw an error when QR code generation fails
[22m[39mFailed to generate QR code: Error: Generation failed
    at [90m/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/lib/2fa/index.test.ts:289:43
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:145:11
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:26
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1209:10[90m)[39m
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1653:37
    at Traces.$ [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.CCmnQaNT.js:142:27[90m)[39m
    at trace [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1653:12[90m)[39m

[90mstderr[2m | src/lib/2fa/index.test.ts[2m > [22m[2mQR Code Module[2m > [22m[2mgenerateQRCodeSVG[2m > [22m[2mshould throw an error when SVG generation fails
[22m[39mFailed to generate QR code SVG: Error: Generation failed
    at [90m/Users/rohanbhandari/Desktop/Workspace/Immigration AI application/immigration-ai/[39msrc/lib/2fa/index.test.ts:317:44
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:145:11
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:26
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1209:10[90m)[39m
    at [90mfile:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1653:37
    at Traces.$ [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.CCmnQaNT.js:142:27[90m)[39m
    at trace [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///Users/rohanbhandari/Desktop/Workspace/Immigration%20AI%20application/immigration-ai/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1653:12[90m)[39m

 [32mâœ“[39m src/lib/2fa/index.test.ts [2m([22m[2m66 tests[22m[2m)[22m[32m 21[2mms[22m[39m
 [32mâœ“[39m src/lib/storage/index.test.ts [2m([22m[2m25 tests[22m[2m)[22m[32m 8[2mms[22m[39m
 [32mâœ“[39m src/lib/validation/index.test.ts [2m([22m[2m23 tests[22m[2m)[22m[32m 12[2mms[22m[39m
 [32mâœ“[39m src/lib/crypto/index.test.ts [2m([22m[2m36 tests[22m[2m)[22m[32m 8[2mms[22m[39m
 [32mâœ“[39m src/lib/stripe/index.test.ts [2m([22m[2m39 tests[22m[2m)[22m[32m 7[2mms[22m[39m
 [32mâœ“[39m src/lib/utils.test.ts [2m([22m[2m10 tests[22m[2m)[22m[32m 6[2mms[22m[39m
 [32mâœ“[39m src/lib/storage/utils.test.ts [2m([22m[2m23 tests[22m[2m)[22m[32m 5[2mms[22m[39m

[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m[1m[41m Failed Tests 20 [49m[22m[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m

[41m[1m FAIL [22m[49m src/lib/ai/index.test.ts[2m > [22mAI Module[2m > [22mAnthropic Integration[2m > [22mgenerateFormAutofill[2m > [22mshould throw error when JSON cannot be parsed
[31m[1mAssertionError[22m: expected [Function] to throw error including 'Could not parse JSON response from Clâ€¦' but got 'No JSON found in response'[39m

Expected: [32m"[7mCould not parse JSON response from Claud[27me"[39m
Received: [31m"[7mNo JSON found in respons[27me"[39m

[36m [2mâ¯[22m src/lib/ai/index.test.ts:[2m1069:9[22m[39m
    [90m1067| [39m        [35mconst[39m { generateFormAutofill } [33m=[39m [35mawait[39m [35mimport[39m([32m'./anthropic'[39m)[33m;[39m
    [90m1068| [39m
    [90m1069| [39m        [35mawait[39m [34mexpect[39m(
    [90m   | [39m        [31m^[39m
    [90m1070| [39m          [34mgenerateFormAutofill[39m({
    [90m1071| [39m            formType[33m:[39m [32m'I-130'[39m[33m,[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[1/20]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m src/lib/auth/index.test.ts[2m > [22mAuthentication Module[2m > [22mAPI Helper Functions[2m > [22mauthenticate[2m > [22mshould return error when profile not found
[31m[1mAssertionError[22m: expected true to be false // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- false[39m
[31m+ true[39m

[36m [2mâ¯[22m src/lib/auth/index.test.ts:[2m623:32[22m[39m
    [90m621| [39m        [35mconst[39m result [33m=[39m [35mawait[39m [34mauthenticate[39m(request)[33m;[39m
    [90m622| [39m
    [90m623| [39m        [34mexpect[39m(result[33m.[39msuccess)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m
    [90m   | [39m                               [31m^[39m
    [90m624| [39m        [35mif[39m ([33m![39mresult[33m.[39msuccess) {
    [90m625| [39m          [34mexpect[39m(result[33m.[39merror)[33m.[39m[34mtoBe[39m([32m'Profile not found'[39m)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[2/20]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m src/lib/auth/index.test.ts[2m > [22mAuthentication Module[2m > [22mAPI Helper Functions[2m > [22mauthenticate[2m > [22mshould check role when roles option provided
[31m[1mAssertionError[22m: expected true to be false // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- false[39m
[31m+ true[39m

[36m [2mâ¯[22m src/lib/auth/index.test.ts:[2m644:32[22m[39m
    [90m642| [39m        const result = await authenticate(request, { roles: ['attorneyâ€¦
    [90m643| [39m
    [90m644| [39m        [34mexpect[39m(result[33m.[39msuccess)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m
    [90m   | [39m                               [31m^[39m
    [90m645| [39m        [35mif[39m ([33m![39mresult[33m.[39msuccess) {
    [90m646| [39m          [34mexpect[39m(result[33m.[39merror)[33m.[39m[34mtoBe[39m([32m'Forbidden'[39m)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[3/20]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m src/lib/auth/index.test.ts[2m > [22mAuthentication Module[2m > [22mAPI Helper Functions[2m > [22mrequireAttorney[2m > [22mshould reject non-attorney role
[31m[1mAssertionError[22m: expected true to be false // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- false[39m
[31m+ true[39m

[36m [2mâ¯[22m src/lib/auth/index.test.ts:[2m748:32[22m[39m
    [90m746| [39m        [35mconst[39m result [33m=[39m [35mawait[39m [34mrequireAttorney[39m(request)[33m;[39m
    [90m747| [39m
    [90m748| [39m        [34mexpect[39m(result[33m.[39msuccess)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m
    [90m   | [39m                               [31m^[39m
    [90m749| [39m        [35mif[39m ([33m![39mresult[33m.[39msuccess) {
    [90m750| [39m          [34mexpect[39m(result[33m.[39mresponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m403[39m)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[4/20]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m src/lib/auth/index.test.ts[2m > [22mAuthentication Module[2m > [22mAPI Helper Functions[2m > [22mrequireAdmin[2m > [22mshould allow admin role
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- true[39m
[31m+ false[39m

[36m [2mâ¯[22m src/lib/auth/index.test.ts:[2m771:32[22m[39m
    [90m769| [39m        [35mconst[39m result [33m=[39m [35mawait[39m [34mrequireAdmin[39m(request)[33m;[39m
    [90m770| [39m
    [90m771| [39m        [34mexpect[39m(result[33m.[39msuccess)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m   | [39m                               [31m^[39m
    [90m772| [39m      })[33m;[39m
    [90m773| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[5/20]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m src/lib/auth/index.test.ts[2m > [22mAuthentication Module[2m > [22mAPI Helper Functions[2m > [22mrequireAttorneyOrAdmin[2m > [22mshould reject client role
[31m[1mAssertionError[22m: expected true to be false // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- false[39m
[31m+ true[39m

[36m [2mâ¯[22m src/lib/auth/index.test.ts:[2m845:32[22m[39m
    [90m843| [39m        [35mconst[39m result [33m=[39m [35mawait[39m [34mrequireAttorneyOrAdmin[39m(request)[33m;[39m
    [90m844| [39m
    [90m845| [39m        [34mexpect[39m(result[33m.[39msuccess)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m
    [90m   | [39m                               [31m^[39m
    [90m846| [39m      })[33m;[39m
    [90m847| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[6/20]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m src/lib/auth/index.test.ts[2m > [22mAuthentication Module[2m > [22mAPI Helper Functions[2m > [22mwithAuth HOF[2m > [22mshould pass options to authenticate
[31m[1mAssertionError[22m: expected "vi.fn()" to not be called at all, but actually been called 1 times[90m

Received: 

[1m  1st vi.fn() call:

[22m    Array [
      Object {
        "headers": Headers {},
        "method": "GET",
        "url": "http://localhost:3000/api/test",
      },
      Object {
        "params": Promise {},
      },
      Object {
        "profile": Object {
          "created_at": "2024-01-01T00:00:00Z",
          "email": "test@example.com",
          "first_name": "Test",
          "id": "test-user-id",
          "last_name": "User",
          "mfa_enabled": false,
          "phone": null,
          "role": "attorney",
          "updated_at": "2024-01-01T00:00:00Z",
        },
        "success": true,
        "user": Object {
          "app_metadata": Object {
            "role": "attorney",
          },
          "email": "test@example.com",
          "id": "test-user-id",
          "user_metadata": Object {
            "full_name": "Test User",
          },
        },
      },
    ]
[31m[90m

Number of calls: [1m1[22m
[31m[39m
[36m [2mâ¯[22m src/lib/auth/index.test.ts:[2m1194:29[22m[39m
    [90m1192| [39m        [35mconst[39m response [33m=[39m [35mawait[39m [34mwrappedHandler[39m(request[33m,[39m context)[33m;[39m
    [90m1193| [39m
    [90m1194| [39m        [34mexpect[39m(handler)[33m.[39mnot[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m   | [39m                            [31m^[39m
    [90m1195| [39m        [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m403[39m)[33m;[39m
    [90m1196| [39m      })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[7/20]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m src/lib/auth/index.test.ts[2m > [22mAuthentication Module[2m > [22mAPI Helper Functions[2m > [22mwithAttorneyAuth HOF[2m > [22mshould reject non-attorney
[31m[1mAssertionError[22m: expected "vi.fn()" to not be called at all, but actually been called 1 times[90m

Received: 

[1m  1st vi.fn() call:

[22m    Array [
      Object {
        "headers": Headers {},
        "method": "GET",
        "url": "http://localhost:3000/api/test",
      },
      Object {
        "params": Promise {},
      },
      Object {
        "profile": Object {
          "created_at": "2024-01-01T00:00:00Z",
          "email": "test@example.com",
          "first_name": "Test",
          "id": "test-user-id",
          "last_name": "User",
          "mfa_enabled": false,
          "phone": null,
          "role": "attorney",
          "updated_at": "2024-01-01T00:00:00Z",
        },
        "success": true,
        "user": Object {
          "app_metadata": Object {
            "role": "attorney",
          },
          "email": "test@example.com",
          "id": "test-user-id",
          "user_metadata": Object {
            "full_name": "Test User",
          },
        },
      },
    ]
[31m[90m

Number of calls: [1m1[22m
[31m[39m
[36m [2mâ¯[22m src/lib/auth/index.test.ts:[2m1241:29[22m[39m
    [90m1239| [39m        [35mconst[39m response [33m=[39m [35mawait[39m [34mwrappedHandler[39m(request[33m,[39m context)[33m;[39m
    [90m1240| [39m
    [90m1241| [39m        [34mexpect[39m(handler)[33m.[39mnot[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m   | [39m                            [31m^[39m
    [90m1242| [39m        [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m403[39m)[33m;[39m
    [90m1243| [39m      })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[8/20]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m src/lib/auth/index.test.ts[2m > [22mAuthentication Module[2m > [22mAPI Helper Functions[2m > [22mwithAdminAuth HOF[2m > [22mshould require admin role
[31m[1mAssertionError[22m: expected "vi.fn()" to be called at least once[39m
[36m [2mâ¯[22m src/lib/auth/index.test.ts:[2m1266:25[22m[39m
    [90m1264| [39m        [35mawait[39m [34mwrappedHandler[39m(request[33m,[39m context)[33m;[39m
    [90m1265| [39m
    [90m1266| [39m        [34mexpect[39m(handler)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m   | [39m                        [31m^[39m
    [90m1267| [39m      })[33m;[39m
    [90m1268| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[9/20]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m src/app/api/cases/cases.test.ts[2m > [22mCases API Routes[2m > [22mGET /api/cases[2m > [22mshould return cases list for authenticated user
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2mâ¯[22m src/app/api/cases/cases.test.ts:[2m337:31[22m[39m
    [90m335| [39m      [35mconst[39m data [33m=[39m [35mawait[39m response[33m.[39m[34mjson[39m()[33m;[39m
    [90m336| [39m
    [90m337| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m338| [39m      [34mexpect[39m(data[33m.[39mcases)[33m.[39m[34mtoHaveLength[39m([34m1[39m)[33m;[39m
    [90m339| [39m      [34mexpect[39m(data[33m.[39mtotal)[33m.[39m[34mtoBe[39m([34m1[39m)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[10/20]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m src/app/api/cases/cases.test.ts[2m > [22mCases API Routes[2m > [22mGET /api/cases[2m > [22mshould pass filter parameters to service
[31m[1mAssertionError[22m: expected "vi.fn()" to be called with arguments: [ ObjectContaining{â€¦}, â€¦(1) ][90m

Number of calls: [1m0[22m
[31m[39m
[36m [2mâ¯[22m src/app/api/cases/cases.test.ts:[2m363:41[22m[39m
    [90m361| [39m
    [90m362| [39m      [90m// The route wraps single values in arrays when using getAll()[39m
    [90m363| [39m      [34mexpect[39m(mockCasesService[33m.[39mgetCases)[33m.[39m[34mtoHaveBeenCalledWith[39m(
    [90m   | [39m                                        [31m^[39m
    [90m364| [39m        expect[33m.[39m[34mobjectContaining[39m({
    [90m365| [39m          status[33m:[39m [[32m'intake'[39m][33m,[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[11/20]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m src/app/api/cases/cases.test.ts[2m > [22mCases API Routes[2m > [22mGET /api/cases[2m > [22mshould handle multiple status filters
[31m[1mAssertionError[22m: expected "vi.fn()" to be called with arguments: [ ObjectContaining{â€¦}, Any<Object> ][90m

Number of calls: [1m0[22m
[31m[39m
[36m [2mâ¯[22m src/app/api/cases/cases.test.ts:[2m386:41[22m[39m
    [90m384| [39m      [35mawait[39m [33mGET[39m(request)[33m;[39m
    [90m385| [39m
    [90m386| [39m      [34mexpect[39m(mockCasesService[33m.[39mgetCases)[33m.[39m[34mtoHaveBeenCalledWith[39m(
    [90m   | [39m                                        [31m^[39m
    [90m387| [39m        expect[33m.[39m[34mobjectContaining[39m({
    [90m388| [39m          status[33m:[39m [[32m'intake'[39m[33m,[39m [32m'in_review'[39m][33m,[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[12/20]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m src/app/api/cases/cases.test.ts[2m > [22mCases API Routes[2m > [22mPOST /api/cases[2m > [22mshould create a case for attorney
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

[36m [2mâ¯[22m src/app/api/cases/cases.test.ts:[2m413:31[22m[39m
    [90m411| [39m      [35mconst[39m data [33m=[39m [35mawait[39m response[33m.[39m[34mjson[39m()[33m;[39m
    [90m412| [39m
    [90m413| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m414| [39m      [34mexpect[39m(data[33m.[39msuccess)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m415| [39m      expect(mockCasesService.createCase).toHaveBeenCalledWith(validCaâ€¦

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[13/20]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m src/app/api/cases/cases.test.ts[2m > [22mCases API Routes[2m > [22mPOST /api/cases[2m > [22mshould return 403 for non-attorney user
[31m[1mAssertionError[22m: expected 500 to be 403 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 403[39m
[31m+ 500[39m

[36m [2mâ¯[22m src/app/api/cases/cases.test.ts:[2m443:31[22m[39m
    [90m441| [39m      [35mconst[39m response [33m=[39m [35mawait[39m [33mPOST[39m(request)[33m;[39m
    [90m442| [39m
    [90m443| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m403[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m444| [39m    })[33m;[39m
    [90m445| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[14/20]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m src/app/api/cases/cases.test.ts[2m > [22mCases API Routes[2m > [22mPOST /api/cases[2m > [22mshould return 400 for invalid data
[31m[1mAssertionError[22m: expected 500 to be 400 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 400[39m
[31m+ 500[39m

[36m [2mâ¯[22m src/app/api/cases/cases.test.ts:[2m455:31[22m[39m
    [90m453| [39m      [35mconst[39m response [33m=[39m [35mawait[39m [33mPOST[39m(request)[33m;[39m
    [90m454| [39m
    [90m455| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m400[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m456| [39m    })[33m;[39m
    [90m457| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[15/20]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m src/app/api/cases/cases.test.ts[2m > [22mCases API Routes[2m > [22mPOST /api/cases[2m > [22mshould validate client_id is a UUID
[31m[1mAssertionError[22m: expected 500 to be 400 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 400[39m
[31m+ 500[39m

[36m [2mâ¯[22m src/app/api/cases/cases.test.ts:[2m471:31[22m[39m
    [90m469| [39m      [35mconst[39m data [33m=[39m [35mawait[39m response[33m.[39m[34mjson[39m()[33m;[39m
    [90m470| [39m
    [90m471| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m400[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m472| [39m      [34mexpect[39m(data[33m.[39merror)[33m.[39m[34mtoContain[39m([32m'Invalid client ID'[39m)[33m;[39m
    [90m473| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[16/20]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m src/app/api/cases/cases.test.ts[2m > [22mCases API Routes[2m > [22mGET /api/cases/stats[2m > [22mshould return stats for attorney
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2mâ¯[22m src/app/api/cases/cases.test.ts:[2m914:31[22m[39m
    [90m912| [39m      [35mconst[39m data [33m=[39m [35mawait[39m response[33m.[39m[34mjson[39m()[33m;[39m
    [90m913| [39m
    [90m914| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m915| [39m      [34mexpect[39m(data[33m.[39mtotal)[33m.[39m[34mtoBe[39m([34m10[39m)[33m;[39m
    [90m916| [39m      [34mexpect[39m(data[33m.[39mbyStatus)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[17/20]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m src/app/api/cases/cases.test.ts[2m > [22mCases API Routes[2m > [22mGET /api/cases/stats[2m > [22mshould return stats for admin
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2mâ¯[22m src/app/api/cases/cases.test.ts:[2m928:31[22m[39m
    [90m926| [39m      [35mconst[39m response [33m=[39m [35mawait[39m [33mGET[39m(request)[33m;[39m
    [90m927| [39m
    [90m928| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m929| [39m    })[33m;[39m
    [90m930| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[18/20]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m src/app/api/cases/cases.test.ts[2m > [22mCases API Routes[2m > [22mGET /api/cases/stats[2m > [22mshould return 403 for client
[31m[1mAssertionError[22m: expected 500 to be 403 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 403[39m
[31m+ 500[39m

[36m [2mâ¯[22m src/app/api/cases/cases.test.ts:[2m950:31[22m[39m
    [90m948| [39m      [35mconst[39m response [33m=[39m [35mawait[39m [33mGET[39m(request)[33m;[39m
    [90m949| [39m
    [90m950| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m403[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m951| [39m    })[33m;[39m
    [90m952| [39m  })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[19/20]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m src/app/api/cases/cases.test.ts[2m > [22mCases API Routes[2m > [22mAuthorization Edge Cases[2m > [22mshould allow attorney to access their own cases even when filtering by client
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2mâ¯[22m src/app/api/cases/cases.test.ts:[2m1032:31[22m[39m
    [90m1030| [39m      [35mconst[39m response [33m=[39m [35mawait[39m [33mGET[39m(request)[33m;[39m
    [90m1031| [39m
    [90m1032| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m1033| [39m    })[33m;[39m
    [90m1034| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[20/20]âŽ¯[22m[39m


[2m Test Files [22m [1m[31m3 failed[39m[22m[2m | [22m[1m[32m19 passed[39m[22m[90m (22)[39m
[2m      Tests [22m [1m[31m20 failed[39m[22m[2m | [22m[1m[32m954 passed[39m[22m[2m | [22m[33m3 skipped[39m[90m (977)[39m
[2m   Start at [22m 14:28:01
[2m   Duration [22m 4.64s[2m (transform 3.33s, setup 4.63s, import 4.90s, tests 2.63s, environment 14.37s)[22m

